

# –ü–ª–∞–Ω: –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä –¥–ª—è D-—á–∞—Ç–∞ ‚Äî –∞–≥—Ä–µ–≥–∞—Ü–∏—è –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏–∑–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤

## –û–±–∑–æ—Ä

–ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞ –∏–∑ –ù–∞–≤–∏–≥–∞—Ç–æ—Ä–∞ –≤ D-—á–∞—Ç:
1. –°–æ–±–∏—Ä–∞–µ—Ç—Å—è –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç: –∑–∞–ø—Ä–æ—Å –°—É–ø–µ—Ä–≤–∏–∑–æ—Ä–∞ + –≤—Å–µ –æ—Ç–≤–µ—Ç—ã –ò–ò-—ç–∫—Å–ø–µ—Ä—Ç–æ–≤
2. –ö–æ–Ω—Ç–µ–∫—Å—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–æ–≤–æ–π –ò–ò-—Ä–æ–ª–∏ "–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä"
3. –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, —É–¥–∞–ª—è–µ—Ç –ø–æ–≤—Ç–æ—Ä—ã –∏ —à—É–º
4. –ò—Ç–æ–≥–æ–≤–æ–µ —Ä–µ–∑—é–º–µ –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è –∫–∞–∫ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ D-—á–∞—Ç–∞

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è

```text
+------------------+                    +------------------+
|   ChatTreeNav    |                    |   D-Chat Panel   |
|                  |                    |                  |
|  [Supervisor]    |                    |  [–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä...]  | ‚Üê –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π
|  [AI Response 1] | ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí  –†–µ–∑—é–º–µ:        |   –∑–∞–ø—Ä–æ—Å –º–æ–¥–µ—Ä–∞—Ü–∏–∏
|  [AI Response 2] |     aggregated     |  - –¢–æ—á–∫–∞ 1      |
|  [AI Response 3] |     content        |  - –¢–æ—á–∫–∞ 2      |
|  [üîç Lightbulb]  |                    |  - –í—ã–≤–æ–¥        |
+------------------+                    +------------------+
```

## –ò–∑–º–µ–Ω–µ–Ω–∏—è

### 1. –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ ChatTreeNav ‚Äî –ø–µ—Ä–µ–¥–∞—á–∞ –ø–æ–ª–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

–í–º–µ—Å—Ç–æ –ø–µ—Ä–µ–¥–∞—á–∏ —Ç–æ–ª—å–∫–æ `content` —Å–æ–æ–±—â–µ–Ω–∏—è –°—É–ø–µ—Ä–≤–∏–∑–æ—Ä–∞, —Å–æ–±–∏—Ä–∞–µ–º –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –±–ª–æ–∫–∞:

| –ë—ã–ª–æ | –°—Ç–∞–ª–æ |
|------|-------|
| `onSendToDChat(messageId, supervisorContent)` | `onSendToDChat(messageId, aggregatedContent, messages[])` |

### 2. –ù–æ–≤–∞—è —Ä–æ–ª—å "–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä" –≤ –±—ç–∫–µ–Ω–¥–µ

–î–æ–±–∞–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è —Ä–æ–ª–∏ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞:

| –†–æ–ª—å | –ó–∞–¥–∞—á–∞ |
|------|--------|
| –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä | –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–∏—Å–∫—É—Å—Å–∏—é, —É–¥–∞–ª–∏—Ç—å –ø–æ–≤—Ç–æ—Ä—ã, –≤—ã–¥–µ–ª–∏—Ç—å –∫–ª—é—á–µ–≤—ã–µ —Ç–µ–∑–∏—Å—ã |

### 3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –≤ ConsultantPanel

–ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏–∑ –Ω–∞–≤–∏–≥–∞—Ç–æ—Ä–∞:
1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä
2. –†–µ–∑—É–ª—å—Ç–∞—Ç –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –∫–∞–∫ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ D-—á–∞—Ç–∞
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –¥–∏–∞–ª–æ–≥ —Å –ª—é–±–æ–π —Ä–æ–ª—å—é

### 4. UI –∏–Ω–¥–∏–∫–∞—Ü–∏—è

- –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ–±—Ä–∞–±–æ—Ç–∫–∏ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–º
- –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è ‚Äî —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ–∑—é–º–µ

## –î–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ callback onSendToDChat

```typescript
// ChatTreeNav.tsx - –Ω–æ–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
interface ChatTreeNavProps {
  // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ props
  onSendToDChat?: (
    messageId: string,
    aggregatedContent: string,
    sourceMessages: Array<{
      role: string;
      model_name: string | null;
      content: string;
    }>
  ) => void;
}

// SupervisorNode - —Å–±–æ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
const handleSendToDChat = useCallback((e: React.MouseEvent) => {
  e.stopPropagation();
  
  // –°–æ–±–∏—Ä–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å—É–ø–µ—Ä–≤–∏–∑–æ—Ä–∞ + –≤—Å–µ –æ—Ç–≤–µ—Ç—ã AI
  const allMessages = [
    { 
      role: 'user', 
      model_name: null, 
      content: block.supervisorMessage?.content || '' 
    },
    ...block.aiResponses.map(ai => ({
      role: ai.role,
      model_name: ai.modelName,
      content: messages.find(m => m.id === ai.id)?.content || ''
    }))
  ];
  
  // –§–æ—Ä–º–∏—Ä—É–µ–º –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞
  const aggregatedContent = formatForModerator(allMessages);
  
  onSendToDChat?.(block.id, aggregatedContent, allMessages);
}, [onSendToDChat, block, messages]);
```

### –§–æ—Ä–º–∞—Ç –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞

```typescript
function formatForModerator(messages: Array<{role: string; model_name: string | null; content: string}>): string {
  const sections = messages.map((msg, idx) => {
    if (msg.role === 'user') {
      return `## –ó–ê–ü–†–û–° –°–£–ü–ï–†–í–ò–ó–û–†–ê\n${msg.content}`;
    }
    const roleLabel = getRoleLabel(msg.role);
    const modelLabel = msg.model_name?.split('/').pop() || 'Unknown';
    return `## –û–¢–í–ï–¢ ${idx}: ${roleLabel} (${modelLabel})\n${msg.content}`;
  });
  
  return sections.join('\n\n---\n\n');
}
```

### –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞

```typescript
// hydra-orchestrator/index.ts - –¥–æ–±–∞–≤–ª—è–µ–º –≤ defaultPrompts
const defaultPrompts: Record<string, string> = {
  // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ
  moderator: `–¢—ã ‚Äî –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä –¥–∏—Å–∫—É—Å—Å–∏–∏ –º–µ–∂–¥—É –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –ò–ò-—ç–∫—Å–ø–µ—Ä—Ç–∞–º–∏.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞:
1. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –≤—Å–µ –æ—Ç–≤–µ—Ç—ã —ç–∫—Å–ø–µ—Ä—Ç–æ–≤
2. –í—ã–¥–µ–ª–∏—Ç—å –∫–ª—é—á–µ–≤—ã–µ —Ç–µ–∑–∏—Å—ã –∫–∞–∂–¥–æ–≥–æ —ç–∫—Å–ø–µ—Ä—Ç–∞
3. –£–¥–∞–ª–∏—Ç—å —Å–º—ã—Å–ª–æ–≤—ã–µ –ø–æ–≤—Ç–æ—Ä—ã –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π —à—É–º
4. –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ —Ç–µ–º–∞–º
5. –û—Ç–º–µ—Ç–∏—Ç—å —Ç–æ—á–∫–∏ –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞ –∏ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
## –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ
[1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è: —Å—É—Ç—å –≤–æ–ø—Ä–æ—Å–∞ –∏ –æ–±—â–∏–π –≤—ã–≤–æ–¥]

## –ö–ª—é—á–µ–≤—ã–µ —Ç–µ–∑–∏—Å—ã
- [–¢–µ–∑–∏—Å 1] ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–æ: [–∫–∞–∫–∏–º–∏ —ç–∫—Å–ø–µ—Ä—Ç–∞–º–∏]
- [–¢–µ–∑–∏—Å 2] ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–æ: [–∫–∞–∫–∏–º–∏ —ç–∫—Å–ø–µ—Ä—Ç–∞–º–∏]

## –†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å)
- [–¢–æ—á–∫–∞ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è]: [–ø–æ–∑–∏—Ü–∏—è –ê] vs [–ø–æ–∑–∏—Ü–∏—è –ë]

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è
[–§–∏–Ω–∞–ª—å–Ω—ã–π –≤—ã–≤–æ–¥ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞]

–ë—É–¥—å –ª–∞–∫–æ–Ω–∏—á–µ–Ω. –ù–µ –¥–æ–±–∞–≤–ª—è–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä–æ–π –Ω–µ—Ç –≤ –æ—Ç–≤–µ—Ç–∞—Ö —ç–∫—Å–ø–µ—Ä—Ç–æ–≤.`,
};
```

### –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –≤ ConsultantPanel

```typescript
// ConsultantPanel.tsx
interface ConsultantPanelProps {
  // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ
  initialQuery?: {
    messageId: string;
    content: string;
    sourceMessages?: Array<{
      role: string;
      model_name: string | null;
      content: string;
    }>;
  } | null;
}

// –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏–∑ –Ω–∞–≤–∏–≥–∞—Ç–æ—Ä–∞ ‚Äî –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞
useEffect(() => {
  if (initialQuery?.sourceMessages && initialQuery.sourceMessages.length > 1) {
    // –ï—Å—Ç—å –æ—Ç–≤–µ—Ç—ã AI ‚Äî –∑–∞–ø—É—Å–∫–∞–µ–º –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞
    setIsModeratingContext(true);
    sendQuery(
      initialQuery.content,
      'moderator', // –Ω–æ–≤—ã–π —Ä–µ–∂–∏–º
      selectedModel,
      initialQuery.messageId
    ).finally(() => {
      setIsModeratingContext(false);
      onClearInitialQuery?.();
    });
  } else if (initialQuery) {
    // –¢–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å—É–ø–µ—Ä–≤–∏–∑–æ—Ä–∞ ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
    setInput(initialQuery.content);
    setCurrentSourceMessageId(initialQuery.messageId);
    onClearInitialQuery?.();
  }
}, [initialQuery, sendQuery, selectedModel, onClearInitialQuery]);
```

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ "moderator" –≤ useConsultantChat

```typescript
// useConsultantChat.ts
export type ConsultantMode = 'web_search' | 'expert' | 'critic' | 'arbiter' | 'moderator';

const modeToRole: Record<ConsultantMode, string> = {
  web_search: 'consultant',
  expert: 'assistant',
  critic: 'critic',
  arbiter: 'arbiter',
  moderator: 'moderator', // –Ω–æ–≤–∞—è —Ä–æ–ª—å
};
```

## –ü–æ—Ä—è–¥–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤

1. `supabase/functions/hydra-orchestrator/index.ts` ‚Äî –¥–æ–±–∞–≤–∏—Ç—å —Ä–æ–ª—å moderator
2. `src/hooks/useConsultantChat.ts` ‚Äî –¥–æ–±–∞–≤–∏—Ç—å —Ä–µ–∂–∏–º moderator
3. `src/components/warroom/ChatTreeNav.tsx` ‚Äî —Å–±–æ—Ä –ø–æ–ª–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –±–ª–æ–∫–∞
4. `src/components/warroom/ConsultantPanel.tsx` ‚Äî –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ –º–æ–¥–µ—Ä–∞—Ü–∏–∏
5. `src/pages/ExpertPanel.tsx` ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å callback –∏ –ø–µ—Ä–µ–¥–∞—á—É –¥–∞–Ω–Ω—ã—Ö
6. `src/contexts/LanguageContext.tsx` ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–≤–æ–¥—ã –¥–ª—è –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞

## –ù–æ–≤—ã–µ –∫–ª—é—á–∏ –ø–µ—Ä–µ–≤–æ–¥–æ–≤

```typescript
'dchat.moderator': { ru: '–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä', en: 'Moderator' },
'dchat.moderating': { ru: '–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç...', en: 'Moderator analyzing...' },
'dchat.contextAggregated': { ru: '–ê–Ω–∞–ª–∏–∑ {count} –æ—Ç–≤–µ—Ç–æ–≤', en: 'Analyzing {count} responses' },
```

## –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:
1. –ö–ª–∏–∫ –ø–æ –ª–∞–º–ø–æ—á–∫–µ —Å–æ–±–∏—Ä–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –°—É–ø–µ—Ä–≤–∏–∑–æ—Ä–∞ + –≤—Å–µ –æ—Ç–≤–µ—Ç—ã AI-—ç–∫—Å–ø–µ—Ä—Ç–æ–≤
2. D-—á–∞—Ç —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç—Å—è –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞
3. –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–µ—Ç –¥–∏—Å–∫—É—Å—Å–∏—é –∏ —É–¥–∞–ª—è–µ—Ç –ø–æ–≤—Ç–æ—Ä—ã
4. –†–µ–∑—é–º–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –∫–∞–∫ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ D-—á–∞—Ç–∞
5. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é —Å –ª—é–±–æ–π —Ä–æ–ª—å—é

