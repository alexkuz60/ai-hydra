# План интеграции Промпт-Инженера в экосистему Hydra

## Обзор

Промпт-Инженер — штатная единица технического персонала, специализирующаяся на создании, оптимизации и анализе промптов для ИИ-систем. В отличие от экспертных ролей, он **не участвует в коллегиальных обсуждениях**, а работает **как персональный помощник пользователя** при формулировке запросов.

---

## Фаза 1: Ограничение доступа технического персонала ⏳

### 1.1 Исключение из селектора моделей (К-чат)

**Файл:** `src/components/warroom/PerModelSettings.tsx`

Модифицировать компонент для фильтрации технических ролей:

```typescript
// Добавить проп excludeTechnicalStaff в RoleSelectOptions
<RoleSelectOptions excludeTechnicalStaff />
```

**Файл:** `src/components/ui/RoleSelectItem.tsx`

Добавить фильтр `excludeTechnicalStaff`:

```typescript
export function RoleSelectOptions({ 
  excludeRoles = [], 
  excludeTechnicalStaff = false 
}: RoleSelectOptionsProps) {
  return (
    <>
      {AGENT_ROLES
        .filter(role => !excludeRoles.includes(role))
        .filter(role => !excludeTechnicalStaff || !ROLE_CONFIG[role].isTechnicalStaff)
        .map((role) => (
          <RoleSelectItem key={role} value={role} />
        ))}
    </>
  );
}
```

### 1.2 Исключение из Д-чата (ConsultantPanel)

**Файл:** `src/components/warroom/ConsultantPanel.tsx`

Убрать доступ к техническим ролям из режимов консультанта — оставить только экспертные роли.

---

## Фаза 2: Создание интерфейса вызова Промпт-Инженера ⏳

### 2.1 Кнопка вызова помощника в области ввода

**Новый компонент:** `src/components/warroom/PromptEngineerButton.tsx`

```typescript
interface PromptEngineerButtonProps {
  currentInput: string;
  onOptimizedPrompt: (optimizedText: string) => void;
  disabled?: boolean;
}
```

Кнопка с иконкой `Wand2` (пурпурный цвет Промпт-Инженера) для:
- Анализа текущего черновика запроса
- Предложения улучшений с объяснениями
- Генерации альтернативных формулировок

**Интеграция в:** `src/components/warroom/ChatInputArea.tsx`

### 2.2 Аналогичная кнопка в Библиотеке промптов

**Файл:** `src/pages/RoleLibrary.tsx`

Добавить кнопку "Улучшить с ПИ" рядом с полем ввода контента.

---

## Фаза 3: Оркестрация через Аналитика ⏳

### 3.1 Цепочка вызовов

```text
Пользователь → Аналитик (читает контекст) → формирует ТЗ → Промпт-Инженер (выполняет)
```

### 3.2 Новый tool: `brief_prompt_engineer`

**Файл:** `supabase/functions/hydra-orchestrator/tools.ts`

```typescript
{
  type: "function",
  function: {
    name: "brief_prompt_engineer",
    description: "Подготавливает техническое задание для Промпт-Инженера на основе контекста текущей дискуссии",
    parameters: {
      type: "object",
      properties: {
        task_description: { type: "string", description: "Что требуется от Промпт-Инженера" },
        context_summary: { type: "string", description: "Краткое резюме контекста из К-чата" },
        constraints: { type: "array", items: { type: "string" }, description: "Ограничения и требования" }
      },
      required: ["task_description"]
    }
  }
}
```

### 3.3 Обновление системного промпта Аналитика

Добавить инструкции по формированию структурированного ТЗ для ПИ:

```markdown
## Цель
[Что должен сделать Промпт-Инженер]

## Контекст
[Краткое резюме обсуждения]

## Требования
- [Требование 1]
- [Требование 2]

## Ограничения
- [Ограничение 1]
```

---

## Фаза 4: Интеграция с векторной памятью ⏳

### 4.1 Новая таблица: `session_memory`

```sql
CREATE TABLE session_memory (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id uuid REFERENCES sessions(id) ON DELETE CASCADE,
  content text NOT NULL,
  embedding vector(1536), -- для OpenAI ada-002
  chunk_type text DEFAULT 'message', -- 'message' | 'summary' | 'decision'
  source_message_id uuid REFERENCES messages(id) ON DELETE SET NULL,
  created_at timestamptz DEFAULT now()
);

-- RLS: доступ только владельцу сессии
ALTER TABLE session_memory ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Owner can manage session memory" ON session_memory
  FOR ALL USING (
    session_id IN (SELECT id FROM sessions WHERE user_id = auth.uid())
  );
```

### 4.2 Функция обновления памяти

**Новый RPC:** `refresh_session_memory`

### 4.3 Кнопка "Освежить память" в К-чате

**Файл:** `src/pages/ExpertPanel.tsx`

Добавить кнопку с иконкой `Brain` в панель инструментов.

---

## Фаза 5: Паттерны поведения для технического персонала ⏳

### 5.1 Системные паттерны поведения

Добавить записи в `role_behaviors` для:
- **Промпт-Инженер**: триггеры реакций, стиль коммуникации
- **Аналитик**: инструкции по формированию ТЗ
- **Архивариус**: правила работы с памятью

### 5.2 Стратегический паттерн "Оптимизация промпта"

Добавить в `task_blueprints`:

```json
{
  "name": "Prompt Optimization Pipeline",
  "stages": [
    { "name": "Анализ контекста", "roles": ["analyst"] },
    { "name": "Оптимизация", "roles": ["promptengineer"] },
    { "name": "Валидация", "roles": ["analyst"] }
  ]
}
```

---

## Фаза 6: Фоновые процессы Архивариуса ⏳

### 6.1 Мониторинг нагрузки

Архивариус работает в фоне, выбирая моменты низкой активности для:
- Компактификации памяти
- Удаления устаревших записей
- Генерации summary для длинных дискуссий

### 6.2 Триггер при вызове Промпт-Инженера

При вызове ПИ — сначала Архивариус обновляет память:

```typescript
async function invokePromptEngineer(sessionId: string, userRequest: string) {
  // 1. Архивариус обновляет память (если устарела)
  await refreshSessionMemoryIfNeeded(sessionId);
  
  // 2. Аналитик формирует ТЗ (с доступом к свежей памяти)
  const brief = await analystBrief(sessionId, userRequest);
  
  // 3. Промпт-Инженер выполняет задачу
  return await promptEngineerExecute(brief);
}
```

---

## Фаза 7: Пакетное создание промптов (архитектура) 📋

*Реализация отложена*

### 7.1 Интерфейс

Страница/диалог для массовой генерации:
- Загрузка списка тем/ролей
- Параметры генерации
- Прогресс-бар и результаты

### 7.2 API

**Новый tool:** `batch_prompt_generation`

---

## Диаграмма взаимодействия

```
┌─────────────────────────────────────────────────────────────────┐
│                        ПОЛЬЗОВАТЕЛЬ                             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────────────┐  │
│  │ К-чат ввод  │    │ Библиотека  │    │ Редактор промптов   │  │
│  │ [🪄 ПИ]     │    │ [🪄 ПИ]     │    │ [🪄 ПИ]             │  │
│  └──────┬──────┘    └──────┬──────┘    └──────────┬──────────┘  │
└─────────┼──────────────────┼─────────────────────┼──────────────┘
          │                  │                     │
          └──────────────────┴─────────────────────┘
                             │
                             ▼
              ┌──────────────────────────────┐
              │    АРХИВАРИУС (фоновый)      │
              │  • Обновить память если      │
              │    устарела > 5 мин          │
              └──────────────┬───────────────┘
                             │
                             ▼
              ┌──────────────────────────────┐
              │         АНАЛИТИК             │
              │  • Прочитать память задачи   │
              │  • Сформировать ТЗ для ПИ    │
              └──────────────┬───────────────┘
                             │
                             ▼
              ┌──────────────────────────────┐
              │     ПРОМПТ-ИНЖЕНЕР           │
              │  • Выполнить ТЗ              │
              │  • Вернуть результат         │
              └──────────────┬───────────────┘
                             │
                             ▼
              ┌──────────────────────────────┐
              │    Результат → Пользователь  │
              │  (вставка в поле ввода)      │
              └──────────────────────────────┘
```

---

## Порядок реализации

1. **Фаза 1** (MVP): Ограничение доступа тех.персонала в К-чат/Д-чат
2. **Фаза 2**: Кнопка вызова ПИ в ChatInputArea
3. **Фаза 3**: Связка Аналитик → ПИ через tool
4. **Фаза 4**: Базовая структура session_memory (без эмбеддингов)
5. **Фаза 5**: Системные паттерны поведения
6. **Фаза 6**: Кнопка "Освежить память"
7. **(Позже)**: Эмбеддинги, фоновые процессы Архивариуса, пакетная генерация

---

## Технические риски и решения

| Риск | Решение |
|------|---------|
| Зацикливание агентов | MAX_TOOL_ITERATIONS = 5 уже реализовано |
| Большой контекст памяти | Лимит на количество chunks (50), RAG-поиск |
| Стоимость эмбеддингов | Кэширование, lazy-генерация |
| Конфликты ролей | Валидация через RoleHierarchyEditor |

---

## Итоговый состав технического персонала

| Роль | Функция |
|------|---------|
| **Архивариус** | Управление векторной памятью |
| **Аналитик** | Формирование ТЗ для ПИ |
| **Промпт-Инженер** | Оптимизация промптов |
| **Логистик** | Проектирование data-flow |

---

## Статус

- [x] Аналитик переведён в технический персонал
- [ ] Фаза 1: Ограничение доступа
- [ ] Фаза 2: UI кнопки ПИ
- [ ] Фаза 3: Оркестрация Аналитик → ПИ
- [ ] Фаза 4: Векторная память
- [ ] Фаза 5: Паттерны поведения
- [ ] Фаза 6: Фоновые процессы
