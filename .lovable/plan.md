

# –ü–ª–∞–Ω: –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ D-—á–∞—Ç–∞

## –û–±–∑–æ—Ä

–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä—ë—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π –¥–ª—è D-—á–∞—Ç–∞:
1. –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –≤ D-—á–∞—Ç –∏–∑ –Ω–∞–≤–∏–≥–∞—Ç–æ—Ä–∞ –∫–æ–ª–ª–µ–∫—Ç–∏–≤–Ω–æ–≥–æ —á–∞—Ç–∞ (ChatTreeNav)
2. –ö–Ω–æ–ø–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ D-—á–∞—Ç–∞ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç —Å –ø—Ä–∏–≤—è–∑–∫–æ–π –∫ –∏—Å—Ö–æ–¥–Ω–æ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
3. –ö–Ω–æ–ø–∫–∞ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è/—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ D-—á–∞—Ç–∞

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è

```text
+----------------+---------------------------+------------------+
|  ChatTreeNav   |      –û—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç         |     D-–ß–∞—Ç        |
|                |                           |                  |
|  [–°–æ–æ–±—â–µ–Ω–∏–µ    |                           |  [–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å/    |
|   –°—É–ø–µ—Ä–≤–∏–∑–æ—Ä–∞] |                           |   –°—Ö–ª–æ–ø–Ω—É—Ç—å]     |
|   [üîç] ‚Üê‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí –ó–∞–ø—Ä–æ—Å        |
|                |                           |                  |
|                |    ‚Üê [–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å] ‚Üê‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –û—Ç–≤–µ—Ç D-—á–∞—Ç–∞    |
+----------------+---------------------------+------------------+
```

## –ò–∑–º–µ–Ω–µ–Ω–∏—è

### 1. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ D-—á–∞—Ç" –≤ ChatTreeNav

–ö–Ω–æ–ø–∫–∞ —Ä—è–¥–æ–º —Å —É–∑–ª–æ–º —Å–æ–æ–±—â–µ–Ω–∏—è –°—É–ø–µ—Ä–≤–∏–∑–æ—Ä–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ D-—á–∞—Ç:
- –ò–∫–æ–Ω–∫–∞ –ª–∞–º–ø–æ—á–∫–∏ (Lightbulb) –∫–∞–∫ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä D-—á–∞—Ç–∞
- –ü—Ä–∏ –∫–ª–∏–∫–µ: –ø–µ—Ä–µ–¥–∞—ë–º ID —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤ D-—á–∞—Ç
- D-—á–∞—Ç —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç—Å—è –∏ –≥–æ—Ç–æ–≤ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º

### 2. –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ D-—á–∞—Ç–∞ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç

–ü–æ–¥ –∫–∞–∂–¥—ã–º –æ—Ç–≤–µ—Ç–æ–º –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞ –¥–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É "–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ —á–∞—Ç":
- –í—Å—Ç–∞–≤–ª—è–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç –æ—Ç–≤–µ—Ç–∞ –∫–∞–∫ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç
- –ü—Ä–∏–≤—è–∑–∫–∞ –∫ –∏—Å—Ö–æ–¥–Ω–æ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é —Å—É–ø–µ—Ä–≤–∏–∑–æ—Ä–∞ (–µ—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –±—ã–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∏–∑ –Ω–∞–≤–∏–≥–∞—Ç–æ—Ä–∞)
- –°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î —Å —Ä–æ–ª—å—é `consultant`

### 3. –ö–Ω–æ–ø–∫–∞ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è/—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è D-—á–∞—Ç–∞

–í –∑–∞–≥–æ–ª–æ–≤–∫–µ D-—á–∞—Ç–∞ –¥–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É:
- –ò–∫–æ–Ω–∫–∞ `ChevronRight` (—Å—Ö–ª–æ–ø–Ω—É—Ç—å) / `ChevronLeft` (—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å)
- –ü—Ä–∏ –∫–ª–∏–∫–µ: —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É –ø–∞–Ω–µ–ª–∏ –≤ 3% (—Å—Ö–ª–æ–ø–Ω—É—Ç–æ) –∏–ª–∏ 20% (—Ä–∞–∑–≤—ë—Ä–Ω—É—Ç–æ)

## –î–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –ù–æ–≤—ã–µ Props –∏ Callbacks

**ConsultantPanel:**
```typescript
interface ConsultantPanelProps {
  sessionId: string | null;
  availableModels: ModelOption[];
  isCollapsed: boolean;
  onExpand: () => void;
  onCollapse: () => void;  // –ù–æ–≤—ã–π callback
  // –ö–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞ –∏–∑ –Ω–∞–≤–∏–≥–∞—Ç–æ—Ä–∞
  initialQuery?: {
    messageId: string;
    content: string;
  };
  onClearInitialQuery?: () => void;
  // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç
  onCopyToMainChat?: (content: string, sourceMessageId: string | null) => void;
}
```

**ChatTreeNav:**
```typescript
interface ChatTreeNavProps {
  // –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ props...
  onSendToDChat?: (messageId: string, content: string) => void;  // –ù–æ–≤—ã–π callback
}
```

### –•—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞

```typescript
// –í ExpertPanel.tsx
const [dChatContext, setDChatContext] = useState<{
  messageId: string;
  content: string;
} | null>(null);

const handleSendToDChat = useCallback((messageId: string, content: string) => {
  setDChatContext({ messageId, content });
  saveConsultantPanelWidth(20); // –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º D-—á–∞—Ç
}, [saveConsultantPanelWidth]);
```

### –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç

```typescript
// –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≤ useSendMessage.ts
const copyConsultantResponse = useCallback(async (
  content: string,
  sourceMessageId: string | null
) => {
  if (!sessionId) return;
  
  await supabase.from('messages').insert({
    session_id: sessionId,
    user_id: userId,
    role: 'consultant',
    content,
    metadata: sourceMessageId ? { source_message_id: sourceMessageId } : null,
  });
}, [sessionId, userId]);
```

### UI —ç–ª–µ–º–µ–Ω—Ç—ã

**–ö–Ω–æ–ø–∫–∞ –≤ SupervisorNode (ChatTreeNav):**
```typescript
<Tooltip>
  <TooltipTrigger asChild>
    <Button
      variant="ghost"
      size="icon"
      className="h-5 w-5 opacity-0 group-hover/block:opacity-100"
      onClick={(e) => {
        e.stopPropagation();
        onSendToDChat?.(block.id, block.contentPreview);
      }}
    >
      <Lightbulb className="h-3 w-3 text-hydra-consultant" />
    </Button>
  </TooltipTrigger>
  <TooltipContent>{t('dchat.sendToConsultant')}</TooltipContent>
</Tooltip>
```

**–ö–Ω–æ–ø–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–¥ –æ—Ç–≤–µ—Ç–æ–º D-—á–∞—Ç–∞:**
```typescript
{!isUser && !message.isLoading && onCopyToMainChat && (
  <div className="mt-2 pt-2 border-t border-border/50">
    <Button
      variant="ghost"
      size="sm"
      className="h-6 text-xs"
      onClick={() => onCopyToMainChat(message.content, message.sourceMessageId)}
    >
      <Copy className="h-3 w-3 mr-1" />
      {t('dchat.copyToChat')}
    </Button>
  </div>
)}
```

**–ö–Ω–æ–ø–∫–∞ —Å–≤–µ—Ä–Ω—É—Ç—å –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ D-—á–∞—Ç–∞:**
```typescript
<Button
  variant="ghost"
  size="icon"
  className="h-7 w-7"
  onClick={onCollapse}
>
  <ChevronRight className="h-3.5 w-3.5 text-muted-foreground" />
</Button>
```

## –ü–æ—Ä—è–¥–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤

1. `src/contexts/LanguageContext.tsx` ‚Äî –Ω–æ–≤—ã–µ –∫–ª—é—á–∏ –ø–µ—Ä–µ–≤–æ–¥–æ–≤
2. `src/hooks/useConsultantChat.ts` ‚Äî —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ç–∏–ø–∞ ConsultantMessage –¥–ª—è sourceMessageId
3. `src/hooks/useSendMessage.ts` ‚Äî —Ñ—É–Ω–∫—Ü–∏—è copyConsultantResponse
4. `src/components/warroom/ConsultantPanel.tsx` ‚Äî –Ω–æ–≤—ã–µ props –∏ UI —ç–ª–µ–º–µ–Ω—Ç—ã
5. `src/components/warroom/ChatTreeNav.tsx` ‚Äî –∫–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ D-—á–∞—Ç
6. `src/pages/ExpertPanel.tsx` ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤—Å–µ—Ö –Ω–æ–≤—ã—Ö callbacks

## –ù–æ–≤—ã–µ –∫–ª—é—á–∏ –ø–µ—Ä–µ–≤–æ–¥–æ–≤

```typescript
'dchat.sendToConsultant': { ru: '–°–ø—Ä–æ—Å–∏—Ç—å –≤ D-—á–∞—Ç–µ', en: 'Ask in D-Chat' },
'dchat.copyToChat': { ru: '–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ —á–∞—Ç', en: 'Copy to chat' },
'dchat.collapse': { ru: '–°–≤–µ—Ä–Ω—É—Ç—å', en: 'Collapse' },
'dchat.expand': { ru: '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å', en: 'Expand' },
'dchat.contextFrom': { ru: '–ö–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑: –°–æ–æ–±—â–µ–Ω–∏–µ #{index}', en: 'Context from: Message #{index}' },
```

## –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:
1. –í –Ω–∞–≤–∏–≥–∞—Ç–æ—Ä–µ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –°—É–ø–µ—Ä–≤–∏–∑–æ—Ä–∞ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –∫–Ω–æ–ø–∫–∞ –ª–∞–º–ø–æ—á–∫–∏
2. –ö–ª–∏–∫ –ø–æ –ª–∞–º–ø–æ—á–∫–µ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç D-—á–∞—Ç –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞
3. –ü–æ–¥ –æ—Ç–≤–µ—Ç–∞–º–∏ D-—á–∞—Ç–∞ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –∫–Ω–æ–ø–∫–∞ "–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ —á–∞—Ç"
4. –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –æ—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç –∫–∞–∫ —Å–æ–æ–±—â–µ–Ω–∏–µ –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞
5. –í –∑–∞–≥–æ–ª–æ–≤–∫–µ D-—á–∞—Ç–∞ –µ—Å—Ç—å –∫–Ω–æ–ø–∫–∞ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è –ø–∞–Ω–µ–ª–∏

