
# План: Мультитаб-редактор секций системных промптов

## Обзор
Реализация структурированного просмотра и редактирования системных промптов в разделе «Штат специалистов» с разбивкой на логические секции через табы.

## Архитектура решения

### 1. Парсинг промптов на секции

Создать утилиту `src/lib/promptSectionParser.ts`:

```text
+--------------------------------------------------+
|  parsePromptSections(prompt: string)             |
|  -> { title, sections: PromptSection[] }         |
+--------------------------------------------------+
|  PromptSection:                                  |
|  - key: string (identity, competencies, etc.)    |
|  - title: string (## Идентичность)               |
|  - content: string                               |
|  - isCustom: boolean                             |
+--------------------------------------------------+
```

**Стандартные секции** (по порядку):
- `identity` — Идентичность
- `competencies` — Компетенции  
- `methodology` — Методология работы / Методология оптимизации / Типичные задачи
- `format` — Формат ответов (опционально)
- `teamwork` — Взаимодействие с командой
- `limitations` — Ограничения
- `supervisor` — Пожелания Супервизора

**Кастомные секции**: любые `## Заголовок`, не входящие в стандартные.

### 2. Компонент просмотра секций

Создать `src/components/staff/PromptSectionsViewer.tsx`:
- Вертикальный `TabsList` с иконками для каждой секции
- `TabsContent` с Markdown-рендерингом содержимого
- Индикатор пустых секций (muted badge)

### 3. Компонент редактирования секций

Создать `src/components/staff/PromptSectionsEditor.tsx`:
- Те же табы, но с `Textarea` вместо просмотра
- Кнопка «+ Добавить секцию» для кастомных табов
- Drag-and-drop для переупорядочивания (опционально, Phase 2)
- Валидация: секция `identity` обязательна

### 4. Футер с инструкциями (опционально)

В `PromptSectionsEditor` добавить сворачиваемый `Collapsible`:
```
┌─────────────────────────────────────────────┐
│ 💡 Советы по написанию секции «Компетенции» │
│   • Используй списки для перечислений       │
│   • Начинай с глаголов действия             │
│   • Ограничь 5-7 ключевыми навыками         │
└─────────────────────────────────────────────┘
```

Контент зависит от активного таба (контекстные подсказки).

### 5. Интеграция в RoleDetailsPanel

Заменить текущий `<pre>` / `<Textarea>` блок на:
- **Режим просмотра**: `<PromptSectionsViewer sections={parsedSections} />`
- **Режим редактирования**: `<PromptSectionsEditor sections={...} onChange={...} />`

Сохранить обратную сборку секций в единую строку при сохранении:
```ts
sectionsToPrompt(title, sections) -> string
```

---

## Детали реализации

### Файлы для создания

| Файл | Назначение |
|------|-----------|
| `src/lib/promptSectionParser.ts` | Парсинг и сборка промптов |
| `src/components/staff/PromptSectionsViewer.tsx` | Компонент просмотра |
| `src/components/staff/PromptSectionsEditor.tsx` | Компонент редактирования |

### Файлы для изменения

| Файл | Изменения |
|------|-----------|
| `src/components/staff/RoleDetailsPanel.tsx` | Интеграция новых компонентов |

### Иконки для секций (Lucide)

| Секция | Иконка |
|--------|--------|
| Идентичность | `UserCircle` |
| Компетенции | `GraduationCap` |
| Методология | `ListChecks` |
| Формат ответов | `FileText` |
| Взаимодействие | `Users` |
| Ограничения | `AlertTriangle` |
| Пожелания Супервизора | `Crown` |
| Кастомная | `Bookmark` |

### Добавление новых секций

При нажатии «+ Секция»:
1. Показать input для ввода названия
2. Создать новую вкладку с пустым содержимым
3. Переключиться на неё автоматически
4. Пометить `isCustom: true`

### Валидация

- Секция «Идентичность» обязательна
- Пустые секции допустимы (будут исключены при сборке)
- Дубликаты названий запрещены

---

## UI-макет

```text
┌─────────────────────────────────────────────────────────────┐
│ Системный промпт                           [✏️ Редактировать]│
├─────────────────────────────────────────────────────────────┤
│ ┌──────────────┬─────────────────────────────────────────┐  │
│ │[👤 Идентич.] │ # Эксперт — Универсальный специалист    │  │
│ │  🎓 Компет.  │                                          │  │
│ │  📋 Методол. │ Ты — Эксперт в системе AI-Hydra,        │  │
│ │  📄 Формат   │ универсальный специалист...              │  │
│ │  👥 Команда  │                                          │  │
│ │  ⚠️ Огранич. │                                          │  │
│ │  👑 Супервиз.│                                          │  │
│ │  ─────────── │                                          │  │
│ │  [+ Секция]  │                                          │  │
│ └──────────────┴─────────────────────────────────────────┘  │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 💡 Совет: Чётко определи роль и место в системе Hydra  │ │
│ └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

---

## Последовательность разработки

1. **Шаг 1**: Создать `promptSectionParser.ts` с функциями парсинга
2. **Шаг 2**: Создать `PromptSectionsViewer.tsx` (режим просмотра)
3. **Шаг 3**: Интегрировать Viewer в RoleDetailsPanel
4. **Шаг 4**: Создать `PromptSectionsEditor.tsx` (режим редактирования)
5. **Шаг 5**: Добавить функцию «+ Секция»
6. **Шаг 6**: Добавить контекстный футер с подсказками
7. **Шаг 7**: Тестирование и полировка

---

## Технические детали

### Парсинг секций (regex)

```ts
const SECTION_REGEX = /^## (.+)$/gm;

function parsePromptSections(prompt: string): ParsedPrompt {
  // 1. Извлечь заголовок (первая строка # ...)
  // 2. Разбить по ## на секции
  // 3. Маппинг на стандартные ключи
  // 4. Помечать нестандартные как isCustom
}
```

### Сборка обратно

```ts
function sectionsToPrompt(title: string, sections: PromptSection[]): string {
  return `# ${title}\n\n` + 
    sections
      .filter(s => s.content.trim())
      .map(s => `## ${s.title}\n${s.content}`)
      .join('\n\n');
}
```

### Типы

```ts
interface PromptSection {
  key: string;           // 'identity' | 'competencies' | 'custom_1'
  title: string;         // 'Идентичность'
  content: string;       // Содержимое секции
  icon: LucideIcon;      // Иконка для таба
  isCustom: boolean;     // true для пользовательских
}

interface ParsedPrompt {
  title: string;         // 'Эксперт — Универсальный специалист'
  sections: PromptSection[];
}
```
