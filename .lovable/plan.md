
# План: Фильтрация устаревших моделей

## Проблема
Модель `phi-3-mini` была удалена из актуального списка `PERSONAL_KEY_MODELS`, но её ID остался в сохранённой конфигурации задачи (`session_config.selectedModels`) в базе данных. При отображении задачи и открытии селектора моделей эти устаревшие ID не фильтруются, что приводит к:
- Отображению несуществующих моделей в списке выбранных
- Невозможности удалить их через UI (нет чекбокса в списке)
- Ошибкам при попытке использовать эти модели в чате

## Решение
Добавить автоматическую фильтрацию устаревших моделей при загрузке данных из базы.

---

## Изменения

### 1. `src/pages/Tasks.tsx`

**Добавить функцию фильтрации:**
```typescript
// Filter out deprecated/unavailable model IDs
const filterValidModels = (modelIds: string[]) => {
  const allModelIds = [...LOVABLE_AI_MODELS, ...PERSONAL_KEY_MODELS].map(m => m.id);
  return modelIds.filter(id => allModelIds.includes(id));
};
```

**Применить фильтрацию в двух местах:**

1. При открытии задачи (`handleOpenTask`):
   - Фильтровать `savedModels` перед передачей в `navigate()`

2. При открытии Sheet для редактирования (`handleStartEditModels`):
   - Фильтровать `editingModels` при загрузке из `task.session_config`

3. При отображении моделей в списке задач:
   - Фильтровать `task.session_config.selectedModels` перед рендерингом

### 2. `src/components/warroom/MultiModelSelector.tsx`

**Добавить автоматическую очистку при монтировании:**
- При инициализации компонента проверять `value` на наличие устаревших ID
- Вызывать `onChange()` с отфильтрованным списком, если найдены невалидные ID

---

## Технические детали

```text
┌─────────────────────────────────────────────────────────────┐
│  База данных (session_config)                                │
│  selectedModels: ['phi-3-mini-1', 'llama-3.2-3b', ...]      │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  filterValidModels()                                         │
│  - Сравнивает с LOVABLE_AI_MODELS + PERSONAL_KEY_MODELS     │
│  - Удаляет ID которых нет в актуальном списке               │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  UI получает только валидные модели                          │
│  selectedModels: ['llama-3.2-3b', ...]                       │
└─────────────────────────────────────────────────────────────┘
```

---

## Файлы для изменения

| Файл | Изменение |
|------|-----------|
| `src/pages/Tasks.tsx` | Добавить `filterValidModels()` и применить в 3 местах |
| `src/components/warroom/MultiModelSelector.tsx` | Добавить `useEffect` для автоочистки невалидных ID |
