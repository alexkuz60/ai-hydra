

# План исправления проблем со скелетонами и таймаутом

## Выявленные проблемы

### 1. Скелетоны не отображаются при отправке консультанту
Функция `sendToConsultant` в `useSendMessage.ts` не вызывает `onRequestStart`, поэтому индикаторы ожидания не создаются.

### 2. UX-проблема с UnifiedSendButton
Когда выбран консультант, основная кнопка отправляет ТОЛЬКО ему. Если пользователь хочет отправить всем экспертам, он должен нажать на выпадающее меню — это сбивает с толку.

### 3. Таймер не обновляется при изменении timeoutSeconds
В `useEffect` для таймера `timeoutSeconds` не включён в массив зависимостей, поэтому изменение слайдера не влияет на логику таймаута до перезапуска pending-состояния.

## Изменения

### Файл 1: `src/hooks/useSendMessage.ts`

Добавить вызов `onRequestStart` в функцию `sendToConsultant`:

```typescript
// После вставки user message, перед callOrchestrator
if (onRequestStart) {
  const modelName = consultantId.split('/').pop() || consultantId;
  onRequestStart([{
    modelId: consultantId,
    modelName,
    role: 'consultant',
  }]);
}
```

### Файл 2: `src/pages/ExpertPanel.tsx`

Добавить `timeoutSeconds` в зависимости таймера:

```typescript
// Строка 236
}, [pendingResponses.size, timeoutSeconds]);
```

Это позволит таймеру корректно реагировать на изменение настройки слайдера.

### Файл 3: `src/components/warroom/UnifiedSendButton.tsx` (опционально)

Улучшить UX: когда консультант выбран, показывать обе кнопки явно или сбрасывать выбор после отправки. Текущее поведение может путать пользователей.

**Предлагаемое улучшение:**
- После отправки консультанту автоматически сбрасывать `selectedConsultant` на `null`
- Или добавить визуальную подсказку о текущем режиме

## Итог исправлений

После применения:
1. Скелетоны будут появляться при отправке как всем экспертам, так и консультанту
2. Изменение таймаута через слайдер будет сразу влиять на логику (активные pending-индикаторы)
3. При срабатывании таймаута появится диалог выбора действий

## Тестирование

1. Отправить запрос всем экспертам → скелетоны должны появиться
2. Изменить таймаут на 10 секунд → скелетоны должны показать таймаут через 10с
3. Нажать "Персональный запрос" → скелетон сбрасывается и отправляется повторный запрос
4. Отправить консультанту → скелетон для консультанта должен появиться

