

# План: Интерактивное утверждение предложений супервизором

## Общее описание

Добавляем новую возможность для ролей специалистов — **"Утверждение Супервизором"**. Когда эта опция включена для роли, ИИ-специалист будет формировать структурированные предложения, которые пользователь может утвердить или отклонить по пунктам, аналогично интерфейсу утверждения плана в Lovable.

```text
┌─────────────────────────────────────────────────────────────────┐
│  Карточка специалиста (RoleDetailsPanel)                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [✓] Утверждение Супервизором                                   │
│      └─ Ответы специалиста будут содержать                      │
│         интерактивные предложения для утверждения               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│  Сообщение специалиста с предложениями                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  💡 Эксперт предлагает следующие решения:                       │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ ☐ 1. Реорганизовать структуру компонентов               │  │
│  │      Описание: Переместить общие компоненты...           │  │
│  │                                            [Комментарий] │  │
│  ├───────────────────────────────────────────────────────────┤  │
│  │ ☐ 2. Внедрить систему кэширования                       │  │
│  │      Описание: Использовать React Query для...           │  │
│  │                                            [Комментарий] │  │
│  ├───────────────────────────────────────────────────────────┤  │
│  │ ☐ 3. Добавить мониторинг производительности             │  │
│  │      Описание: Интегрировать систему метрик...           │  │
│  │                                            [Комментарий] │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│  [Утвердить выбранные]  [Отклонить все]  [Запросить детали]    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Этапы реализации

### Этап 1: Расширение схемы данных

**1.1 Миграция базы данных**
- Добавить поле `requires_approval BOOLEAN DEFAULT false` в таблицу `role_behaviors`
- Это поле определяет, требуют ли ответы данной роли утверждения супервизором

**1.2 Обновление типов**
- Расширить интерфейс `RoleBehavior` в `src/types/patterns.ts` новым полем `requires_approval`

---

### Этап 2: UI настройки в RoleDetailsPanel

**2.1 Добавить Switch для опции утверждения**
- Разместить под секцией "Technical Staff" или в отдельной секции настроек
- Текст: "Утверждение Супервизором" с тултипом-объяснением
- При изменении — сохранять в `role_behaviors`

**2.2 Обновить хук useRoleBehavior**
- Добавить поле `requires_approval` в загружаемые/сохраняемые данные

---

### Этап 3: Структура предложений в сообщениях

**3.1 Определить формат предложений**
Специалист будет использовать специальный markdown-блок:

```markdown
:::proposals
- id: 1
  title: Реорганизовать структуру
  description: Переместить общие компоненты в shared/
  priority: high
- id: 2
  title: Внедрить кэширование
  description: Использовать React Query
  priority: medium
:::
```

Или JSON-формат в метаданных сообщения:
```typescript
interface MessageMetadata {
  // ... существующие поля
  proposals?: Proposal[];
  approval_status?: ApprovalStatus;
}

interface Proposal {
  id: string;
  title: string;
  description: string;
  priority?: 'high' | 'medium' | 'low';
  status: 'pending' | 'approved' | 'rejected' | 'needs_clarification';
  comment?: string;
}
```

---

### Этап 4: Компонент интерактивного утверждения

**4.1 Создать ProposalApprovalBlock**
Новый компонент `src/components/warroom/ProposalApprovalBlock.tsx`:

- Отображает список предложений с чекбоксами
- Каждый пункт содержит:
  - Чекбокс статуса (pending → approved/rejected)
  - Заголовок и описание
  - Индикатор приоритета (цветная метка)
  - Кнопка "Комментарий" для добавления заметки
- Нижняя панель с действиями:
  - "Утвердить выбранные" — сохраняет статус approved
  - "Отклонить все" — ставит rejected всем
  - "Запросить детали" — генерирует follow-up сообщение

**4.2 Интеграция в ChatMessage**
- В `ChatMessage.tsx` добавить рендеринг `ProposalApprovalBlock` при наличии `metadata.proposals`
- Обработчики изменения статуса обновляют метаданные сообщения в БД

---

### Этап 5: Инструкции в системном промпте

**5.1 Дополнение системного промпта**
Когда `requires_approval = true`, в системный промпт роли добавляется инструкция:

```
Формат ответа: Когда предлагаешь решения или план действий, структурируй их в JSON-блоке:
\`\`\`json:proposals
[
  {"id": "1", "title": "Название", "description": "Описание", "priority": "high"},
  ...
]
\`\`\`
Пользователь сможет утвердить или отклонить каждый пункт отдельно.
```

**5.2 Обновить hydra-orchestrator**
- Парсить блок `json:proposals` из ответа
- Сохранять в `metadata.proposals` сообщения

---

### Этап 6: Сохранение решений

**6.1 Обновление метаданных сообщения**
- При изменении статуса предложения — вызов `supabase.from('messages').update({ metadata })`
- Поддержка частичного обновления без перезаписи других полей

**6.2 История решений**
- Опционально: логировать изменения статуса в отдельной таблице `approval_history`

---

## Локализация

Добавить ключи:
```typescript
'staffRoles.requiresApproval': { ru: 'Утверждение Супервизором', en: 'Supervisor Approval' },
'staffRoles.requiresApprovalHint': { 
  ru: 'Ответы специалиста будут содержать интерактивные предложения для утверждения', 
  en: 'Specialist responses will include interactive proposals for approval' 
},
'proposals.title': { ru: 'Предложения для утверждения', en: 'Proposals for Approval' },
'proposals.approve': { ru: 'Утвердить выбранные', en: 'Approve Selected' },
'proposals.reject': { ru: 'Отклонить все', en: 'Reject All' },
'proposals.requestDetails': { ru: 'Запросить детали', en: 'Request Details' },
'proposals.addComment': { ru: 'Добавить комментарий', en: 'Add Comment' },
'proposals.approved': { ru: 'Утверждено', en: 'Approved' },
'proposals.rejected': { ru: 'Отклонено', en: 'Rejected' },
'proposals.pending': { ru: 'Ожидает решения', en: 'Pending' },
```

---

## Затрагиваемые файлы

| Файл | Изменения |
|------|-----------|
| `supabase/migrations/` | Новая миграция: добавление поля `requires_approval` |
| `src/types/patterns.ts` | Расширение `RoleBehavior` и новые типы `Proposal`, `ApprovalStatus` |
| `src/types/messages.ts` | Расширение `MessageMetadata` полями `proposals` |
| `src/hooks/useRoleBehavior.ts` | Поддержка нового поля |
| `src/components/staff/RoleDetailsPanel.tsx` | UI для настройки опции |
| `src/components/warroom/ProposalApprovalBlock.tsx` | **Новый** — интерактивный блок утверждения |
| `src/components/warroom/ChatMessage.tsx` | Интеграция `ProposalApprovalBlock` |
| `src/contexts/LanguageContext.tsx` | Новые ключи локализации |
| `supabase/functions/hydra-orchestrator/index.ts` | Парсинг блока proposals |

---

## Риски и соображения

1. **Обратная совместимость**: Новое поле имеет значение по умолчанию `false`, существующие роли не затрагиваются
2. **UX сложность**: Интерфейс утверждения должен быть интуитивным и не перегружать визуально
3. **Производительность**: Обновление метаданных происходит асинхронно, блокировки UI нет
4. **Формат данных**: JSON-структура в метаданных — гибкий подход, но требует валидации

