
# План реорганизации системы паттернов и Гидропедии

## Обзор

Реорганизация направлена на разделение системных (внутренних) компонентов платформы от пользовательских инструментов. Стратегические паттерны и ролевые шаблоны станут частью "дрессировки Гидры" — скрытой от обычных пользователей системы настройки поведения ИИ.

---

## 1. Скрытие стратегических паттернов в Flow Editor

### Проблема
При нажатии "Открыть в редакторе потоков" в деталях паттерна создаётся Flow-диаграмма. Эти сгенерированные диаграммы отображаются в общем списке "Открыть" в редакторе потоков.

### Решение
Добавить признак `source` к таблице `flow_diagrams` для отличия сгенерированных диаграмм от пользовательских.

**Изменения:**
- **База данных**: Добавить колонку `source TEXT DEFAULT 'user'` (значения: `'user'` | `'pattern'`)
- **`src/hooks/useFlowDiagrams.ts`**: Фильтровать диаграммы в списке "Открыть" по `source !== 'pattern'`
- **`src/components/patterns/PatternDetailsPanel.tsx`**: При сохранении диаграммы передавать `source: 'pattern'`
- **`src/types/flow.ts`**: Добавить поле `source?: 'user' | 'pattern'` в интерфейс

---

## 2. Страница "Дрессировка Гидры" в Гидропедии

### Проблема
Необходима специальная страница документации, видимая только администраторам, описывающая внутреннее устройство системы паттернов.

### Решение
Добавить свойство `adminOnly` к секциям Гидропедии и создать новую секцию.

**Изменения:**
- **`src/content/hydrapedia.ts`**:
  - Добавить `adminOnly?: boolean` в интерфейс `HydrapediaSection`
  - Добавить новую секцию `hydra-training` с иконкой `Shield`
  - Контент: описание стратегических паттернов, ролевых шаблонов, их применения

- **`src/pages/Hydrapedia.tsx`**:
  - Импортировать `useUserRoles`
  - Фильтровать `hydrapediaSections`: показывать секции с `adminOnly: true` только если `isAdmin`

- **`src/contexts/LanguageContext.tsx`**:
  - Добавить ключи локализации для заголовка секции

---

## 3. Скрытие системных паттернов от обычных пользователей

### Проблема
Страница `/behavioral-patterns` показывает все паттерны всем пользователям. Системные паттерны ("инстинкты Гидры") должны быть видны только администраторам.

### Решение
Фильтрация паттернов на основе ролей пользователя.

**Изменения:**
- **`src/pages/BehavioralPatterns.tsx`**:
  - Импортировать `useUserRoles`
  - Для НЕ-админов фильтровать `blueprints` и `behaviors` по `!meta.isSystem`
  - Админы видят всё

---

## 4. Разделение ролевых шаблонов на секции

### Проблема
Ролевые шаблоны отображаются единым списком. Необходимо разделить на "Эксперты" и "Технический персонал".

### Решение
Использовать существующий флаг `isTechnicalStaff` из `ROLE_CONFIG`.

**Изменения:**
- **`src/pages/BehavioralPatterns.tsx`**:
  - Разделить `behaviors` на две группы:
    - `expertBehaviors` = где `ROLE_CONFIG[role].isTechnicalStaff === false`
    - `techBehaviors` = где `ROLE_CONFIG[role].isTechnicalStaff === true`
  - Добавить два сворачиваемых раздела в таблице:
    - "Эксперты" (Sparkles icon)
    - "Технический персонал" (Wrench icon)
  - Каждый раздел со своим счётчиком и кнопкой создания

- **`src/contexts/LanguageContext.tsx`**:
  - Добавить ключи: `patterns.expertGroup`, `patterns.technicalGroup`

---

## Диаграмма архитектуры доступа

```text
+------------------------+     +------------------------+
|    Обычный пользователь|     |      Администратор     |
+------------------------+     +------------------------+
          |                              |
          v                              v
+--------------------+         +----------------------+
| Паттерны поведения |         | Паттерны поведения   |
|--------------------|         |----------------------|
| [x] Свои паттерны  |         | [x] Все паттерны     |
| [ ] Системные      |         | [x] Системные        |
| [x] Публичные      |         | [x] Публичные        |
+--------------------+         +----------------------+
          |                              |
          v                              v
+--------------------+         +----------------------+
| Flow Editor        |         | Flow Editor          |
|--------------------|         |----------------------|
| source='user' only |         | Все диаграммы        |
+--------------------+         +----------------------+
          |                              |
          v                              v
+--------------------+         +----------------------+
| Гидропедия         |         | Гидропедия           |
|--------------------|         |----------------------|
| [ ] Дрессировка    |         | [x] Дрессировка      |
| [x] Остальные      |         | [x] Все секции       |
+--------------------+         +----------------------+
```

---

## Технические детали

### Новые ключи локализации
```typescript
'patterns.expertGroup': { ru: 'Эксперты', en: 'Experts' }
'patterns.technicalGroup': { ru: 'Технический персонал', en: 'Technical Staff' }
'hydrapedia.sections.hydraTraining': { ru: 'Дрессировка Гидры', en: 'Hydra Training' }
```

### Миграция БД
```sql
ALTER TABLE flow_diagrams 
ADD COLUMN source TEXT DEFAULT 'user' 
CHECK (source IN ('user', 'pattern'));
```

### Файлы для изменения
1. `src/hooks/useFlowDiagrams.ts` — фильтрация по source
2. `src/components/patterns/PatternDetailsPanel.tsx` — передача source при сохранении
3. `src/types/flow.ts` — расширение типа
4. `src/content/hydrapedia.ts` — новая секция + флаг adminOnly
5. `src/pages/Hydrapedia.tsx` — фильтрация секций по роли
6. `src/pages/BehavioralPatterns.tsx` — фильтрация паттернов + разделение ролей
7. `src/contexts/LanguageContext.tsx` — новые ключи локализации

---

## Порядок реализации

1. Миграция БД (добавление колонки `source`)
2. Обновление типов и хуков для Flow Editor
3. Обновление генерации диаграмм из паттернов
4. Фильтрация в BehavioralPatterns + разделение на секции
5. Добавление секции "Дрессировка Гидры" в Гидропедию
6. Фильтрация секций Гидропедии по роли
7. Локализация
