
# –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ Streaming Responses –¥–ª—è AI-Hydra

## ‚úÖ –°—Ç–∞—Ç—É—Å: –≠—Ç–∞–ø 1 –∏ 2 –ó–ê–í–ï–†–®–ï–ù–´

### –≠—Ç–∞–ø 1: D-Chat Streaming (–ó–ê–í–ï–†–®–Å–ù)
- ‚úÖ `supabase/functions/hydra-stream/index.ts` - SSE edge-—Ñ—É–Ω–∫—Ü–∏—è
- ‚úÖ `src/hooks/useStreamingChat.ts` - –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Ö—É–∫ –¥–ª—è D-Chat
- ‚úÖ `src/components/warroom/StreamingMessage.tsx` - UI-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è D-Chat
- ‚úÖ `src/components/warroom/ConsultantPanel.tsx` - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- ‚úÖ `src/components/warroom/MarkdownRenderer.tsx` - –¥–æ–±–∞–≤–ª–µ–Ω streaming prop

### –≠—Ç–∞–ø 2: Expert Panel Hybrid Streaming (–ó–ê–í–ï–†–®–Å–ù)
- ‚úÖ `src/hooks/useStreamingResponses.ts` - —Ö—É–∫ –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö SSE-–ø–æ—Ç–æ–∫–æ–≤
- ‚úÖ `src/components/warroom/StreamingMessageCard.tsx` - –∫–∞—Ä—Ç–æ—á–∫–∞ streaming-—Å–æ–æ–±—â–µ–Ω–∏—è
- ‚úÖ `src/components/warroom/ChatMessagesList.tsx` - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è streaming + pending
- ‚úÖ `src/pages/ExpertPanel.tsx` - hybrid streaming mode

---

## –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

### –¢–µ–∫—É—â–∏–π flow –±–µ–∑ streaming:
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí useSendMessage ‚Üí hydra-orchestrator (–æ–∂–∏–¥–∞–Ω–∏–µ 5-120 —Å–µ–∫) 
‚Üí –û—Ç–≤–µ—Ç –≤ –ë–î ‚Üí Realtime subscription ‚Üí UI –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–∫–µ–ª–µ—Ç–æ–Ω —Å —Ç–∞–π–º–µ—Ä–æ–º. –û—Ç–≤–µ—Ç –ø–æ—è–≤–ª—è–µ—Ç—Å—è —Ü–µ–ª–∏–∫–æ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.

### –ì–¥–µ streaming –¥–∞—Å—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç:

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ |
|-----------|-----------|-------------|
| **D-Chat (ConsultantPanel)** | üî¥ –í—ã—Å–æ–∫–∏–π | –û–¥–∏–Ω–æ—á–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã, –±—ã—Å—Ç—Ä—ã–µ –∏—Ç–µ—Ä–∞—Ü–∏–∏, –ø—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è |
| **Expert Panel (–æ—Å–Ω–æ–≤–Ω–æ–π)** | üü° –°—Ä–µ–¥–Ω–∏–π | –ú–Ω–æ–≥–æ–º–æ–¥–µ–ª—å–Ω—ã–π –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º, —Ç—Ä–µ–±—É–µ—Ç –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö –ø–æ—Ç–æ–∫–æ–≤ |
| **–ü–µ—Ä–µ–≤–æ–¥ reasoning** | üü¢ –ù–∏–∑–∫–∏–π | –§–æ–Ω–æ–≤–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∂–¥—ë—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –æ—Ç–≤–µ—Ç |

---

## –≠—Ç–∞–ø 1: Streaming –¥–ª—è D-Chat (ConsultantPanel)

### 1.1 –ù–æ–≤–∞—è edge-—Ñ—É–Ω–∫—Ü–∏—è `hydra-stream`

–°–æ–∑–¥–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è streaming –æ–¥–∏–Ω–æ—á–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:

**–§–∞–π–ª:** `supabase/functions/hydra-stream/index.ts`

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**
- –í—Ö–æ–¥–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: `session_id`, `message`, `model_id`, `role`, `system_prompt`
- –í—ã—Ö–æ–¥–Ω–æ–π —Ñ–æ—Ä–º–∞—Ç: SSE (Server-Sent Events) —Å `text/event-stream`
- –§–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö: OpenAI-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π (`delta.content`)

**–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ü–∞—Ä–∞–º–µ—Ç—Ä `stream: true` –≤ –∑–∞–ø—Ä–æ—Å–µ –∫ Lovable AI Gateway
- –ü—Ä—è–º–æ–µ –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ SSE –ø–æ—Ç–æ–∫–∞ –±–µ–∑ –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏–∏
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –ë–î –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–æ—Ç–æ–∫–∞

### 1.2 –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Ö—É–∫ `useStreamingChat`

**–§–∞–π–ª:** `src/hooks/useStreamingChat.ts`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- SSE –ø–∞—Ä—Å–∏–Ω–≥ –ø–æ —Å—Ç—Ä–æ–∫–∞–º (–Ω–µ –ø–æ –¥–≤–æ–π–Ω—ã–º –ø–µ—Ä–µ–≤–æ–¥–∞–º —Å—Ç—Ä–æ–∫–∏)
- –û–±—Ä–∞–±–æ—Ç–∫–∞ `[DONE]` —Å–∏–≥–Ω–∞–ª–∞
- –ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ state
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ 429/402

```typescript
// –ü—Å–µ–≤–¥–æ–∫–æ–¥
async function streamChat(params) {
  const resp = await fetch('/functions/v1/hydra-stream', {...});
  const reader = resp.body.getReader();
  let buffer = '';
  let accumulatedContent = '';
  
  while (true) {
    const { done, value } = await reader.read();
    if (done) break;
    buffer += decode(value);
    
    // –ü–∞—Ä—Å–∏–Ω–≥ —Å—Ç—Ä–æ–∫ SSE
    while (buffer.includes('\n')) {
      const line = buffer.slice(0, buffer.indexOf('\n'));
      buffer = buffer.slice(buffer.indexOf('\n') + 1);
      
      if (line.startsWith('data: ')) {
        const json = line.slice(6);
        if (json === '[DONE]') break;
        const delta = JSON.parse(json).choices[0]?.delta?.content;
        if (delta) {
          accumulatedContent += delta;
          onDelta(delta);
        }
      }
    }
  }
  onDone(accumulatedContent);
}
```

### 1.3 –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `ConsultantPanel`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –ó–∞–º–µ–Ω–∏—Ç—å `useConsultantChat` –Ω–∞ `useStreamingChat` 
- –û–±–Ω–æ–≤–∏—Ç—å `ConsultantMessageItem` –¥–ª—è –ø–æ–∫–∞–∑–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –ø–æ –º–µ—Ä–µ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è
- –î–æ–±–∞–≤–∏—Ç—å –º–∏–≥–∞—é—â–∏–π –∫—É—Ä—Å–æ—Ä –≤–æ –≤—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

---

## –≠—Ç–∞–ø 2: Streaming –¥–ª—è Expert Panel (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### 2.1 –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã

**–í–∞—Ä–∏–∞–Ω—Ç A: –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ SSE –ø–æ—Ç–æ–∫–∏**
- Frontend –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç N SSE —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ –º–æ–¥–µ–ª—å)
- –ö–∞–∂–¥—ã–π –ø–æ—Ç–æ–∫ –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–≤–æ–π "—Å–ª–æ—Ç" —Å–æ–æ–±—â–µ–Ω–∏—è
- –°–ª–æ–∂–Ω–æ—Å—Ç—å: —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ N —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è–º–∏, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è UI

**–í–∞—Ä–∏–∞–Ω—Ç B: Multiplexed SSE**
- –û–¥–Ω–æ SSE —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –æ—Ç edge-—Ñ—É–Ω–∫—Ü–∏–∏
- –°–æ–±—ã—Ç–∏—è –º–∞—Ä–∫–∏—Ä—É—é—Ç—Å—è `model_id` –¥–ª—è —Ä–æ—É—Ç–∏–Ω–≥–∞
- –°–ª–æ–∂–Ω–æ—Å—Ç—å: —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –º—É–ª—å—Ç–∏–ø–ª–µ–∫—Å–æ—Ä–∞ –Ω–∞ backend

**–í–∞—Ä–∏–∞–Ω—Ç C: Hybrid (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π)**
- –ü–µ—Ä–≤—ã–µ 2-3 —Å–µ–∫—É–Ω–¥—ã –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∫–µ–ª–µ—Ç–æ–Ω—ã (–∫–∞–∫ —Å–µ–π—á–∞—Å)
- –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–µ—Ä–≤–æ–≥–æ —Ç–æ–∫–µ–Ω–∞ –∑–∞–º–µ–Ω—è–µ–º —Å–∫–µ–ª–µ—Ç–æ–Ω –Ω–∞ streaming-–±–ª–æ–∫
- Fallback –Ω–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Ö–∞–Ω–∏–∑–º –µ—Å–ª–∏ –º–æ–¥–µ–ª—å –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç streaming
–†–µ–∞–ª–∏–∑—É–π –≤–∞—Ä–∏–∞–Ω—Ç –ì–∏–±—Ä–∏–¥–Ω—ã–π

### 2.2 –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `hydra-orchestrator` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä `stream_mode`:
- `none` ‚Äî —Ç–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
- `single` ‚Äî streaming –¥–ª—è –æ–¥–Ω–æ–π –º–æ–¥–µ–ª–∏
- `multiplexed` ‚Äî —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç —Å –º—É–ª—å—Ç–∏–ø–ª–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ–º

---

## –≠—Ç–∞–ø 3: Streaming-ready –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã UI

### 3.1 –ù–æ–≤—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç `StreamingMessage`

**–§–∞–π–ª:** `src/components/warroom/StreamingMessage.tsx`

```typescript
interface StreamingMessageProps {
  modelName: string;
  role: AgentRole;
  content: string;
  isStreaming: boolean;
  onComplete?: () => void;
}
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ú–∏–≥–∞—é—â–∏–π –∫—É—Ä—Å–æ—Ä `‚ñå` –≤ –∫–æ–Ω—Ü–µ —Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ `isStreaming=true`
- –ü–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –±–µ–∑ "–ø—Ä—ã–∂–∫–æ–≤"
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ markdown rendering –Ω–∞ –ª–µ—Ç—É

### 3.2 –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `MarkdownRenderer`

–î–æ–±–∞–≤–∏—Ç—å –æ–ø—Ü–∏—é `streaming` –¥–ª—è –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å–ª–æ–∂–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤:
- –¢–∞–±–ª–∏—Ü—ã —Ä–µ–Ω–¥–µ—Ä—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ `isStreaming=false`
- Mermaid –¥–∏–∞–≥—Ä–∞–º–º—ã –∂–¥—É—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–æ—Ç–æ–∫–∞
- –ö–æ–¥-–±–ª–æ–∫–∏ —Å –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É—é—Ç—Å—è

---

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### Edge-—Ñ—É–Ω–∫—Ü–∏—è `hydra-stream`

```typescript
// supabase/functions/hydra-stream/index.ts
serve(async (req) => {
  // ... auth check ...
  
  const response = await fetch("https://ai.gateway.lovable.dev/v1/chat/completions", {
    method: "POST",
    headers: {
      "Authorization": `Bearer ${apiKey}`,
      "Content-Type": "application/json",
    },
    body: JSON.stringify({
      model,
      messages: [...],
      stream: true, // –ö–ª—é—á–µ–≤–æ–π –ø–∞—Ä–∞–º–µ—Ç—Ä
    }),
  });

  // –ü—Ä—è–º–æ–µ –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Ç–æ–∫–∞
  return new Response(response.body, {
    headers: {
      "Content-Type": "text/event-stream",
      "Cache-Control": "no-cache",
      ...CORS_HEADERS,
    },
  });
});
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

- **429 Rate Limit**: Toast + exponential backoff
- **402 Payment Required**: Toast —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º –ø–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å
- **Connection lost**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry —Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
- **Partial response**: –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç + –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ—à–∏–±–∫–∏

---

## –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

| –≠—Ç–∞–ø | –ó–∞–¥–∞—á–∞ | –§–∞–π–ª—ã |
|------|--------|-------|
| 1.1 | Edge-—Ñ—É–Ω–∫—Ü–∏—è hydra-stream | `supabase/functions/hydra-stream/index.ts` |
| 1.2 | –•—É–∫ useStreamingChat | `src/hooks/useStreamingChat.ts` |
| 1.3 | StreamingMessage –∫–æ–º–ø–æ–Ω–µ–Ω—Ç | `src/components/warroom/StreamingMessage.tsx` |
| 1.4 | –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ ConsultantPanel | `src/components/warroom/ConsultantPanel.tsx` |
| 2.0 | (–æ–ø—Ü.) Multi-model streaming | `hydra-orchestrator`, `ExpertPanel` |

---

## –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

**–î–æ:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∂–¥—ë—Ç 10-60 —Å–µ–∫ –≥–ª—è–¥—è –Ω–∞ —Å–∫–µ–ª–µ—Ç–æ–Ω —Å —Ç–∞–π–º–µ—Ä–æ–º
- –û—Ç–≤–µ—Ç –ø–æ—è–≤–ª—è–µ—Ç—Å—è —Ü–µ–ª–∏–∫–æ–º –æ–¥–Ω–∏–º –±–ª–æ–∫–æ–º
- –ù–µ–ø–æ–Ω—è—Ç–Ω–æ, —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–∏ –∑–∞–ø—Ä–æ—Å

**–ü–æ—Å–ª–µ:**
- –ü–µ—Ä–≤—ã–µ —Å–∏–º–≤–æ–ª—ã –ø–æ—è–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ 0.5-2 —Å–µ–∫
- –¢–µ–∫—Å—Ç "–ø–µ—á–∞—Ç–∞–µ—Ç—Å—è" –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –æ –ø—Ä–æ—Ü–µ—Å—Å–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- –ú–æ–∂–Ω–æ –Ω–∞—á–∏–Ω–∞—Ç—å —á–∏—Ç–∞—Ç—å –æ—Ç–≤–µ—Ç –¥–æ –µ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

**–ú–µ—Ç—Ä–∏–∫–∏ —É–ª—É—á—à–µ–Ω–∏—è:**
- Time to First Token (TTFT): 2-5 —Å–µ–∫ ‚Üí 0.5-2 —Å–µ–∫ (–æ—â—É—â–∞–µ–º–æ–µ)
- Perceived latency: -70%
- User engagement: –æ–∂–∏–¥–∞–µ–º—ã–π —Ä–æ—Å—Ç –±–ª–∞–≥–æ–¥–∞—Ä—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
