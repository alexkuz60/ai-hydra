
# План: Секция «Пожелания Супервизора» и режимы использования инструментов

## Обзор задачи

Необходимо расширить системные промпты и настройки инструментов двумя взаимосвязанными функциями:

1. **Секция «Пожелания Супервизора»** — добавляется ко всем 12 промптам как точка гибкой настройки поведения роли под конкретную сессию
2. **Режимы использования инструментов** — определяют, когда инструмент должен вызываться

---

## Часть 1: Секция «Пожелания Супервизора» в промптах

### Концепция

Секция предназначена для динамической настройки поведения роли без редактирования основного промпта. Супервизор (пользователь) может указать дополнительные инструкции через:
- Мини-словари типичных пожеланий (выбор из списка в панели запроса)
- Свободный текст для уникальных случаев

### Структура секции

```markdown
## Пожелания Супервизора

При наличии дополнительных инструкций от Супервизора:
1. Учитывай их как приоритетные для текущей сессии
2. Интегрируй с основной методологией, не противоречь ей
3. При конфликте с базовыми ограничениями — уточни у Супервизора

**Типичные указания:**
- [Список из словаря, специфичный для роли]
```

### Содержание по ролям

| Роль | Типичные пожелания Супервизора |
|------|-------------------------------|
| **Эксперт** | «Сфокусируйся на X», «Приводи больше примеров», «Ответ для новичка» |
| **Критик** | «Будь жёстче», «Фокус на логике», «Проверь факты» |
| **Арбитр** | «Приоритет мнению X», «Нужен консенсус», «Сохрани все нюансы» |
| **Консультант** | «Максимум деталей», «Только ключевые тезисы», «Практические шаги» |
| **Модератор** | «Краткое резюме», «Полный отчёт», «Выдели расхождения» |
| **Советник** | «Горизонт 1 год», «Минимизируй риски», «Агрессивный рост» |
| **Web-Охотник** | «Только .edu источники», «Свежие данные (2024+)», «Сравни источники» |
| **Архивариус** | «Найди по ключевым словам», «Очисти дубликаты», «Создай каталог» |
| **Аналитик** | «Количественный анализ», «Визуализируй данные», «Подготовь ТЗ» |
| **Промпт-Инженер** | «Оптимизируй для GPT-5», «Добавь few-shot», «Сократи токены» |
| **Логистик** | «Проверь на циклы», «Добавь параллелизм», «Документируй поток» |
| **Инструменталист** | «Настрой HTTP POST», «Добавь авторизацию», «Извлеки JSONPath» |

---

## Часть 2: Режимы использования инструментов

### Новые режимы

| Режим | Ключ | Поведение | Пример |
|-------|------|-----------|--------|
| **Всегда** | `always` | Инструмент вызывается автоматически при каждом запросе | `current_datetime` — всегда добавлять актуальное время |
| **При необходимости** | `auto` | ИИ-роль сама решает, нужен ли инструмент | `web_search` — искать при запросе актуальных данных |
| **По просьбе** | `on_request` | Только когда пользователь явно просит | `calculator` — «посчитай...» |

### Изменения в типах

```typescript
// src/components/warroom/PerModelSettings.tsx
export type ToolUsageMode = 'always' | 'auto' | 'on_request';

export interface ToolSettings {
  enabled: boolean;
  usageMode: ToolUsageMode;
}

export interface SingleModelSettings {
  // ... existing fields
  toolSettings?: Record<ToolId | string, ToolSettings>; // Новый формат
}
```

### UI в PerModelSettings

Для каждого включённого инструмента добавляется селектор режима:

```
┌─────────────────────────────────────────────┐
│ 🕐 Дата/Время                          [✓] │
│    Режим: [Всегда ▾]                        │
├─────────────────────────────────────────────┤
│ 🔍 Веб-поиск                           [✓] │
│    Режим: [При необходимости ▾]             │
│    Провайдер: [Tavily]                      │
├─────────────────────────────────────────────┤
│ 🧮 Калькулятор                         [✓] │
│    Режим: [По просьбе пользователя ▾]       │
└─────────────────────────────────────────────┘
```

### Передача в оркестратор

```typescript
// useSendMessage.ts - buildModelConfig
{
  enabled_tools: settings.enabledTools,
  tool_settings: settings.toolSettings, // Новое поле с режимами
}
```

---

## Часть 3: Мини-словари пожеланий пользователя

### Концепция

Расширение `behaviorDictionaries.ts` новым словарём `SUPERVISOR_WISHES_DICTIONARY`, содержащим типичные указания для каждой роли.

### Структура словаря

```typescript
// src/config/behaviorDictionaries.ts

export interface SupervisorWish {
  key: string;
  label: { ru: string; en: string };
  description?: { ru: string; en: string };
  roles: AgentRole[]; // К каким ролям применимо
}

export const SUPERVISOR_WISHES_DICTIONARY: SupervisorWish[] = [
  // Универсальные
  { key: 'detailed_response', label: { ru: 'Подробный ответ', en: 'Detailed response' }, roles: ['assistant', 'consultant', 'advisor'] },
  { key: 'concise_response', label: { ru: 'Краткий ответ', en: 'Concise response' }, roles: ['assistant', 'moderator', 'analyst'] },
  { key: 'use_examples', label: { ru: 'Приводи примеры', en: 'Use examples' }, roles: ['assistant', 'consultant', 'promptengineer'] },
  
  // Для Критика
  { key: 'focus_logic', label: { ru: 'Фокус на логике', en: 'Focus on logic' }, roles: ['critic'] },
  { key: 'be_strict', label: { ru: 'Будь жёстче в оценке', en: 'Be stricter' }, roles: ['critic'] },
  
  // Для Web-Охотника
  { key: 'fresh_sources', label: { ru: 'Только свежие источники (2024+)', en: 'Fresh sources only (2024+)' }, roles: ['webhunter'] },
  { key: 'academic_sources', label: { ru: 'Академические источники (.edu)', en: 'Academic sources (.edu)' }, roles: ['webhunter'] },
  
  // ... остальные по ролям
];
```

### UI в панели запроса

Добавить кнопку **«Пожелания»** рядом с селектором моделей, которая открывает выпадающий список с мульти-выбором пожеланий, отфильтрованных по текущим активным ролям.

---

## Часть 4: Интеграция с оркестратором

### Обработка режимов инструментов

```typescript
// hydra-orchestrator/tools.ts

function shouldIncludeTool(
  toolId: string,
  toolSettings: Record<string, ToolSettings>,
  userMessage: string,
  role: AgentRole
): boolean {
  const settings = toolSettings[toolId];
  if (!settings?.enabled) return false;
  
  switch (settings.usageMode) {
    case 'always':
      return true;
    case 'on_request':
      return detectUserToolRequest(userMessage, toolId);
    case 'auto':
    default:
      return true; // ИИ сама решит через tool_choice: 'auto'
  }
}
```

### Обработка пожеланий Супервизора

Пожелания конкатенируются к системному промпту в секции «Пожелания Супервизора»:

```typescript
// hydra-orchestrator/index.ts
const supervisorWishes = requestBody.supervisor_wishes || [];
if (supervisorWishes.length > 0) {
  systemPrompt += `\n\n### Текущие пожелания Супервизора:\n${supervisorWishes.join('\n- ')}`;
}
```

---

## Техническая реализация

### Шаг 1: Обновление промптов в БД и коде (миграция)

1. Добавить секцию «Пожелания Супервизора» ко всем 12 промптам в `prompt_library`
2. Синхронизировать `DEFAULT_SYSTEM_PROMPTS` в `src/config/roles.ts`

### Шаг 2: Расширение типов и UI

1. Добавить `ToolUsageMode` и `ToolSettings` в `PerModelSettings.tsx`
2. Обновить UI селекции инструментов с выбором режима
3. Добавить локализацию для новых элементов

### Шаг 3: Создание словаря пожеланий

1. Добавить `SUPERVISOR_WISHES_DICTIONARY` в `behaviorDictionaries.ts`
2. Создать компонент `SupervisorWishesPicker` для панели запроса
3. Интегрировать в `ChatInputArea.tsx`

### Шаг 4: Обновление оркестратора

1. Добавить обработку `tool_settings` с режимами использования
2. Добавить инъекцию `supervisor_wishes` в системный промпт

### Шаг 5: Обновление Hydrapedia

1. Документировать режимы использования инструментов
2. Описать секцию «Пожелания Супервизора» и её назначение

---

## Ожидаемый результат

1. **12 промптов** получат унифицированную секцию «Пожелания Супервизора» с типичными указаниями для каждой роли
2. **Инструменты** получат три режима использования (Всегда / При необходимости / По просьбе)
3. **Панель запроса** получит быстрый доступ к словарю пожеланий Супервизора
4. **Оркестратор** научится обрабатывать режимы и пожелания
