# 🐙 Hydra — Стратегический план развития

## 🎯 Миссия

**Hydra** — самоэволюционирующая мета-система коллегиального ИИ-анализа, способная расширять свои возможности без программного кода через:
- Библиотеки паттернов поведения
- Ролевую память агентов
- Механизмы самоанализа и автокоррекции

---

## 🧬 Модульная анатомия Hydra

```
┌─────────────────────────────────────────────────────────────────────┐
│                        HYDRA CORE SYSTEM                            │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   ┌─────────────┐    ┌─────────────┐    ┌─────────────────────┐    │
│   │   КАДРЫ     │    │  ЗНАНИЯ     │    │     ЛОГИКА          │    │
│   │  (Roles)    │◄──►│ (Knowledge) │◄──►│  (Flow Processing)  │    │
│   └──────┬──────┘    └──────┬──────┘    └──────────┬──────────┘    │
│          │                  │                      │                │
│          ▼                  ▼                      ▼                │
│   ┌─────────────┐    ┌─────────────┐    ┌─────────────────────┐    │
│   │ Штат спец-в │    │ Промпт-     │    │ Flow Editor         │    │
│   │ (11 ролей)  │    │ библиотека  │    │ (визуальные цепочки)│    │
│   ├─────────────┤    ├─────────────┤    ├─────────────────────┤    │
│   │ Ролевая     │    │ Паттерны    │    │ Шаблоны потоков     │    │
│   │ память      │    │ поведения   │    │ (task blueprints)   │    │
│   └─────────────┘    └─────────────┘    └─────────────────────┘    │
│                                                                     │
├─────────────────────────────────────────────────────────────────────┤
│                         META-LAYER                                  │
│   ┌─────────────────────────────────────────────────────────────┐  │
│   │                    САМОАНАЛИЗ (Introspection)                │  │
│   │  • Оценка эффективности промптов                             │  │
│   │  • Анализ успешности решений                                 │  │
│   │  • Автокоррекция системных инструкций                        │  │
│   └─────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 📦 Модули и их статус

### 1. КАДРЫ (Roles Layer) ✅ Реализовано

| Компонент | Статус | Описание |
|-----------|--------|----------|
| 11 ролей | ✅ | 8 экспертных + 3 технических |
| Штат специалистов UI | ✅ | `/staff-roles` — двухпанельный справочник |
| Динамические промпты | ✅ | Авто-подстановка при выборе роли |
| **Ролевая память** | 🔲 | Накопление опыта между сессиями |

### 2. ЗНАНИЯ (Knowledge Layer) ✅ Частично

| Компонент | Статус | Описание |
|-----------|--------|----------|
| Промпт-библиотека | ✅ | CRUD, фильтры, shared/personal |
| Гидропедия | ✅ | Документация с 100% покрытием |
| **Паттерны поведения** | 🔲 | Шаблоны решения типовых задач |
| **Векторная память** | 🔲 | RAG для контекстного поиска |

### 3. ЛОГИКА (Flow Layer) ✅ Частично

| Компонент | Статус | Описание |
|-----------|--------|----------|
| Flow Editor | ✅ | 18+ типов нод, экспорт |
| Правила соединений | ✅ | Валидация по типам узлов |
| **Шаблоны потоков** | 🔲 | Готовые blueprints для задач |
| **Исполнение потоков** | 🔲 | Runtime для Flow-диаграмм |

### 4. META-LAYER 🔲 В планах

| Компонент | Статус | Описание |
|-----------|--------|----------|
| Самоанализ | 🔲 | Оценка эффективности |
| Автокоррекция | 🔲 | Улучшение промптов на основе опыта |
| Рефлексия | 🔲 | Логирование успехов/неудач |

---

## 🗺️ Стратегические направления

### Направление A: Ролевая память
> Агенты накапливают опыт между сессиями

**Компоненты:**
- `role_memory` — таблица для хранения "воспоминаний" агентов
- Механизм извлечения релевантного опыта при формировании ответа
- UI для просмотра/редактирования накопленных знаний роли

**Зависимости:** Векторная память (embeddings)

---

### Направление B: Паттерны поведения (двухуровневая система)

```
┌─────────────────────────────────────────────────────────────┐
│              СТРАТЕГИЧЕСКИЕ ПАТТЕРНЫ                        │
│         (Task Patterns / Blueprints)                        │
│                                                             │
│   Шаблоны решения типовых ЗАДАЧ                            │
│   • Какие роли участвуют                                    │
│   • Какие этапы проходит решение                           │
│   • Какие артефакты создаются                              │
│   • Какие контрольные точки                                │
├─────────────────────────────────────────────────────────────┤
│              РОЛЕВЫЕ ПАТТЕРНЫ                               │
│         (Role Behavior Patterns)                            │
│                                                             │
│   Поведенческие шаблоны для каждой ИИ-РОЛИ                 │
│   • Стиль коммуникации                                      │
│   • Типовые реакции на ситуации                            │
│   • Форматы вывода                                          │
│   • Взаимодействие с другими ролями                        │
└─────────────────────────────────────────────────────────────┘
```

#### B1: Стратегические паттерны (Task Blueprints)

**Назначение:** Готовые "рецепты" для типовых задач пользователя

**Структура паттерна:**
```typescript
interface TaskBlueprint {
  id: string;
  name: string;                    // "Lovable Project Manager"
  category: 'planning' | 'creative' | 'analysis' | 'technical';
  description: string;
  
  // Какие роли участвуют и в какой последовательности
  stages: Array<{
    name: string;                  // "Анализ требований"
    roles: MessageRole[];          // ['advisor', 'analyst']
    objective: string;             // "Сформировать структурированное ТЗ"
    deliverables: string[];        // ["ТЗ в формате markdown"]
    prompts?: string[];            // ID промптов из библиотеки
  }>;
  
  // Контрольные точки
  checkpoints: Array<{
    after_stage: number;
    condition: string;             // "Пользователь подтвердил ТЗ"
  }>;
}
```

**Примеры стратегических паттернов:**

| Паттерн | Категория | Роли | Этапы |
|---------|-----------|------|-------|
| Lovable Project Manager | planning | Advisor → Analyst → Prompt Engineer | ТЗ → Декомпозиция → Запросы |
| Генеральный Соавтор | creative | Consultant → Archivist → Critic | Концепт → Структура → Редактура |
| Технический аудит | technical | Analyst → Critic → Arbiter | Анализ → Критика → Вердикт |
| Исследование темы | analysis | Web-Hunter → Analyst → Archivist | Поиск → Анализ → Систематизация |

---

#### B2: Ролевые паттерны (Role Behaviors)

**Назначение:** Определяют КАК роль ведёт себя в разных ситуациях

**Структура паттерна:**
```typescript
interface RoleBehavior {
  role: MessageRole;
  
  // Стиль коммуникации
  communication: {
    tone: 'formal' | 'friendly' | 'neutral' | 'provocative';
    verbosity: 'concise' | 'detailed' | 'adaptive';
    format_preference: string[];   // ["markdown", "bullet_points", "code_blocks"]
  };
  
  // Типовые реакции
  reactions: Array<{
    trigger: string;               // "user_asks_for_opinion"
    behavior: string;              // "Предоставить взвешенный анализ с pros/cons"
  }>;
  
  // Взаимодействие с другими ролями
  interactions: {
    defers_to: MessageRole[];      // Кому уступает экспертизу
    challenges: MessageRole[];     // С кем спорит
    collaborates: MessageRole[];   // С кем работает в паре
  };
}
```

**Примеры ролевых паттернов:**

| Роль | Тон | Реакция на несогласие | Взаимодействие |
|------|-----|----------------------|----------------|
| Critic | provocative | Усиливает аргументацию | Спорит с Assistant, уступает Arbiter |
| Consultant | formal | Детализирует с примерами | Сотрудничает с Analyst |
| Arbiter | neutral | Синтезирует позиции | Финализирует после всех |
| Web-Hunter | friendly | Расширяет поиск | Передаёт данные Analyst |

---

#### Взаимосвязь двух уровней

```
Пользователь выбирает ─────► Стратегический паттерн
                                     │
                                     ▼
                           Определяет этапы и роли
                                     │
                    ┌────────────────┼────────────────┐
                    ▼                ▼                ▼
              Advisor          Analyst           Critic
                 │                │                 │
                 ▼                ▼                 ▼
         Ролевой паттерн   Ролевой паттерн   Ролевой паттерн
         (как советует)    (как анализирует) (как критикует)
```

---

### Направление C: Интеграция паттернов с Flow Editor

> Визуальное представление и редактирование паттернов через Flow-диаграммы

---

#### C1: Стратегический паттерн → Flow-диаграмма

Каждый **Task Blueprint** автоматически транслируется в Flow-диаграмму:

```
┌─────────────────────────────────────────────────────────────────────┐
│                    FLOW VISUALIZATION                               │
│                                                                     │
│   ┌─────────┐                                                       │
│   │  INPUT  │  ← Задача пользователя                               │
│   │   ⭕     │                                                       │
│   └────┬────┘                                                       │
│        │                                                            │
│        ▼                                                            │
│   ╔═══════════════════════════════════════════════════════════╗    │
│   ║  STAGE 1: Анализ требований                               ║    │
│   ║  ┌─────────┐    ┌─────────┐    ┌─────────┐               ║    │
│   ║  │ Advisor │───►│ Analyst │───►│ Prompt  │               ║    │
│   ║  │   💡    │    │   📊    │    │ Library │               ║    │
│   ║  └─────────┘    └─────────┘    └────┬────┘               ║    │
│   ╚═════════════════════════════════════│═════════════════════╝    │
│                                         │                          │
│                                    ┌────▼────┐                     │
│                                    │CHECKPOINT│ ← Подтверждение    │
│                                    │    ◆    │   пользователя      │
│                                    └────┬────┘                     │
│                                         │                          │
│   ╔═══════════════════════════════════════════════════════════╗    │
│   ║  STAGE 2: Декомпозиция                                    ║    │
│   ║  ┌─────────┐    ┌─────────┐                               ║    │
│   ║  │ Analyst │───►│Archivist│                               ║    │
│   ║  │   📊    │    │   📚    │                               ║    │
│   ║  └─────────┘    └─────────┘                               ║    │
│   ╚═════════════════════════════════════════════════════════════╝    │
│                                         │                          │
│                                         ▼                          │
│                                   ┌──────────┐                     │
│                                   │  OUTPUT  │ ← Результат        │
│                                   │    ⭕     │                     │
│                                   └──────────┘                     │
└─────────────────────────────────────────────────────────────────────┘
```

**Маппинг элементов:**

| Элемент паттерна | Нода Flow Editor | Тип |
|------------------|------------------|-----|
| Stage | Group Node | `group` (контейнер) |
| Role в stage | Model Node | `model` с привязкой к роли |
| Deliverable | Output Node | `output` |
| Checkpoint | Condition Node | `condition` |
| Промпт из библиотеки | Prompt Node | `prompt` |

---

#### C2: Новые типы нод для паттернов

```typescript
// Нода "Этап" (Stage Node) — специализированный Group
interface StageNodeData {
  type: 'stage';
  stageName: string;           // "Анализ требований"
  stageIndex: number;          // 1, 2, 3...
  objective: string;           // Цель этапа
  isCollapsed: boolean;        // Можно сворачивать
}

// Нода "Checkpoint" — точка контроля
interface CheckpointNodeData {
  type: 'checkpoint';
  condition: string;           // "Пользователь подтвердил"
  requiresUserInput: boolean;  // Ждёт действия пользователя
  autoPass: boolean;           // Авто-пропуск при условии
}

// Нода "Role" — расширенная Model Node
interface RoleNodeData {
  type: 'role';
  role: MessageRole;           // 'advisor', 'analyst', etc.
  behaviorPatternId?: string;  // Ссылка на ролевой паттерн
  promptIds: string[];         // Промпты из библиотеки
}
```

---

#### C3: UI интеграции

**1. Галерея шаблонов в Flow Editor:**
```
┌─────────────────────────────────────────────────────────────┐
│  📋 Шаблоны паттернов                              [+ New]  │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │ 📊 Lovable  │  │ ✍️ Соавтор  │  │ 🔍 Аудит    │         │
│  │ PM          │  │             │  │ кода        │         │
│  │ 4 этапа     │  │ 5 этапов    │  │ 3 этапа     │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
│                                                             │
│  ┌─────────────┐  ┌─────────────┐                          │
│  │ 🌐 Research │  │ ➕ Пустой   │                          │
│  │             │  │ шаблон      │                          │
│  │ 3 этапа     │  │             │                          │
│  └─────────────┘  └─────────────┘                          │
└─────────────────────────────────────────────────────────────┘
```

**2. Панель свойств Stage Node:**
```
┌─────────────────────────────────────────────────────────────┐
│  ⚙️ Этап: Анализ требований                                │
├─────────────────────────────────────────────────────────────┤
│  Название:  [Анализ требований        ]                    │
│  Цель:      [Сформировать ТЗ          ]                    │
│                                                             │
│  Роли в этапе:                                              │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐                       │
│  │💡Advisor│ │📊Analyst│ │ + роль  │                       │
│  └─────────┘ └─────────┘ └─────────┘                       │
│                                                             │
│  Артефакты (deliverables):                                  │
│  ☑ ТЗ в markdown                                           │
│  ☑ Список фич                                              │
│  [ + добавить ]                                            │
│                                                             │
│  ☐ Требует подтверждения пользователя                      │
└─────────────────────────────────────────────────────────────┘
```

---

#### C4: Двунаправленная синхронизация

```
┌──────────────────┐                    ┌──────────────────┐
│  Task Blueprint  │ ◄──── CREATE ────► │  Flow Diagram    │
│   (JSON/DB)      │                    │   (визуальный)   │
├──────────────────┤                    ├──────────────────┤
│                  │                    │                  │
│  • stages[]      │ ◄─── SYNC ───────► │  • Group Nodes   │
│  • roles[]       │                    │  • Role Nodes    │
│  • checkpoints[] │                    │  • Condition     │
│                  │                    │                  │
└──────────────────┘                    └──────────────────┘
         │                                       │
         │                                       │
         ▼                                       ▼
┌──────────────────┐                    ┌──────────────────┐
│   Flow Runtime   │ ◄─── EXECUTE ────► │   Expert Panel   │
│  (исполнение)    │                    │   (чат UI)       │
└──────────────────┘                    └──────────────────┘
```

**Сценарии:**

1. **Создание из UI** → Пользователь рисует диаграмму → Сохраняется как Blueprint
2. **Загрузка шаблона** → Blueprint рендерится как Flow-диаграмма
3. **Редактирование** → Изменения в диаграмме обновляют Blueprint
4. **Запуск** → Blueprint исполняется через Expert Panel с визуализацией прогресса

---

#### C5: Визуализация прогресса в Expert Panel

При исполнении паттерна в чате отображается мини-карта прогресса:

```
┌─────────────────────────────────────────────────────────────┐
│  📋 Lovable Project Manager                    [⬛⬛⬜⬜] 2/4 │
├─────────────────────────────────────────────────────────────┤
│  ✅ Этап 1: Анализ требований     — завершён               │
│  🔄 Этап 2: Декомпозиция          — в процессе             │
│  ⬜ Этап 3: Формулировка запросов — ожидает                │
│  ⬜ Этап 4: Валидация             — ожидает                │
└─────────────────────────────────────────────────────────────┘
```

---

### Направление D: Исполняемые потоки (Flow Runtime)
> Flow-диаграммы как автономные пайплайны

---

### Направление D: Мета-слой самоанализа
> Hydra оценивает и улучшает себя

**Компоненты:**
- Метрики эффективности (время, качество, user feedback)
- A/B тестирование промптов
- Автоматические предложения по улучшению
- Dashboard аналитики

---

## 🎭 Примеры применения (Use Cases)

### 1. Проект-менеджер для Lovable.dev
```
Задача: Спланировать новый проект
Паттерн: "Lovable Project Manager"
Роли: Advisor (стратегия) + Analyst (декомпозиция) + Prompt Engineer (формулировки)

Этапы:
1. Анализ требований → структурированное ТЗ
2. Декомпозиция на фичи → приоритизация
3. Формулировка запросов для каждого шага
4. Контрольные точки оптимизации
5. Финальная валидация
```

### 2. Генеральный Соавтор книги
```
Задача: Написать художественную книгу
Паттерн: "Literary Co-Author"
Роли: Consultant (контент) + Critic (качество) + Archivist (структура)

Этапы:
1. Жанровый анализ → шаблоны и тропы
2. Структура произведения → синопсис
3. Проработка персонажей и мира
4. Главы с итеративной критикой
5. Редактура и полировка
```

### 3. ЭмоЛаб (в планах)
```
Задача: Анализ музыкальных произведений
Паттерн: "Music Emotion Analyzer"
Интеграции: Audio API, Emotion classification, Visualization
```

### 4. Прогнозис (в планах)
```
Задача: Прогнозирование и сценарный анализ
Паттерн: "Forecasting Engine"
Роли: Analyst + Advisor + Arbiter
```

---

## 📊 Roadmap

| Квартал | Фокус | Результат |
|---------|-------|-----------|
| **Q1** | Паттерны поведения | Библиотека базовых паттернов, UI выбора |
| **Q2** | Ролевая память | Персистентный контекст агентов |
| **Q3** | Исполняемые потоки | Flow Runtime MVP |
| **Q4** | Мета-слой | Dashboard самоанализа |

---

## 🔗 Взаимосвязи модулей

```
Паттерны ──────► Определяют какие Роли участвуют
    │                        │
    │                        ▼
    │              Роли используют Промпты
    │                        │
    ▼                        ▼
Flow Editor ◄───── Визуализирует логику обработки
    │
    ▼
Flow Runtime ────► Исполняет пайплайн
    │
    ▼
Мета-слой ◄─────── Анализирует результаты
    │
    └──────────────► Корректирует Промпты/Паттерны
```

---

## 📝 Текущие задачи (из TODO.md)

1. **Brave Search Integration** — ожидает API-ключ
2. **Search Settings UX** — улучшение логики провайдера

---

*Последнее обновление: Февраль 2025*
